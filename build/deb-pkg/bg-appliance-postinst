#!/bin/sh -e
#
# COPYRIGHT 2018 Brightgate Inc.  All rights reserved.
#
# This copyright notice is Copyright Management Information under 17 USC 1202
# and is included to protect this work and deter copyright infringement.
# Removal or alteration of this Copyright Management Information without the
# express written permission of Brightgate Inc is prohibited, and any
# such unauthorized removal or alteration will be a violation of federal law.
#

stopsvc()
{
    if systemctl is-enabled --quiet $1; then
        echo "systemctl disable $1"
        systemctl disable $1
    fi
    if systemctl is-active --quiet $1; then
        echo "systemctl stop $1"
        systemctl stop $1
    fi
}

# Brightgate packaging policy: set -x required.
set -x

if [ "x$1" = "xconfigure" ]; then
    # Disable services that collide with our use, or that we want to manage
    # directly.
    stopsvc dnsmasq.service
    stopsvc avahi-daemon.service

    # Prevent linux from acting like a wlan client
    # Ask the upstream DHCP server to identify itself
    cat >> /etc/dhcpcd.conf << EOF

# Brightgate Options Start
ipv4only
allowinterfaces eth* enx*
denyinterfaces eth*.* enx*.*
option vendor_class_identifier, vendor_encapsulated_options
# Brightgate Options End
EOF

    # Enable appliance services.
    systemctl enable ap.mcp.service
    systemctl enable brightgate-appliance.service

    systemctl start ap.mcp.service
    systemctl start brightgate-appliance.service
fi

# Some other abort action was received.
exit 0
