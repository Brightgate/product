#!/bin/sh -e
#
# COPYRIGHT 2019 Brightgate Inc.  All rights reserved.
#
# This copyright notice is Copyright Management Information under 17 USC 1202
# and is included to protect this work and deter copyright infringement.
# Removal or alteration of this Copyright Management Information without the
# express written permission of Brightgate Inc is prohibited, and any
# such unauthorized removal or alteration will be a violation of federal law.
#

stopsvc() {
	if systemctl is-enabled --quiet $1; then
		echo "systemctl disable $1"
		systemctl disable $1
	fi
	if systemctl is-active --quiet $1; then
		echo "systemctl stop $1"
		systemctl stop $1
	fi
}

optime=$(date -Iseconds)
appackage=/opt/com.brightgate

copy_preserve () {
	if [ -f "$PKG_ROOT/$1" ]; then
		mkdir -p "$PKG_ROOT/$2"
		cp "$PKG_ROOT/$1" "$PKG_ROOT/$2"
		mv "$PKG_ROOT/$1" "$PKG_ROOT/$1.$optime"
	fi
}

# Brightgate packaging policy: set -x required.
set -x

if [ "x$1" = "xconfigure" ]; then
	# Disable services that collide with our use, or that we want to manage
	# directly.
	stopsvc dnsmasq.service
	stopsvc avahi-daemon.service

	# Prevent linux from acting like a wlan client
	# Ask the upstream DHCP server to identify itself
	cat >> /etc/dhcpcd.conf << EOF

	# Brightgate Options Start
	ipv4only
	nohook wpa_supplicant
	allowinterfaces eth* enx*
	denyinterfaces eth*.* enx*.*
	option vendor_class_identifier, vendor_encapsulated_options
	# Brightgate Options End
EOF

	copy_preserve $appackage/etc/secret/cloud/cloud.secret.json \
		$appackage/var/spool/secret/rpcd

	copy_preserve $appackage/etc/ap_props.json \
		$appackage/var/spool/configd
	copy_preserve $appackage/etc/ap_props.json.bak \
		$appackage/var/spool/configd

	copy_preserve /opt/etc/machine-id \
		$appackage/var/spool/mcp

	# Enable appliance services.
	systemctl enable ap.mcp.service
	systemctl enable brightgate-appliance.service

	systemctl start ap.mcp.service
	systemctl start brightgate-appliance.service
fi

# Some other abort action was received.
exit 0
