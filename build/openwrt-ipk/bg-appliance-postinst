#!/bin/ash -e
#
# COPYRIGHT 2019 Brightgate Inc.  All rights reserved.
#
# This copyright notice is Copyright Management Information under 17 USC 1202
# and is included to protect this work and deter copyright infringement.
# Removal or alteration of this Copyright Management Information without the
# express written permission of Brightgate Inc is prohibited, and any
# such unauthorized removal or alteration will be a violation of federal law.
#

# Brightgate packaging policy: set -x required.
set -x

# PKG_UPGRADE=0 indicates an install or remove.

line_add () {
	# $1 - file
	# $2 - line
	# $3 - location - line will be added following this regexp
	if [ ! -f "$PKG_ROOT/$1" ]; then
		echo "$2" > "$PKG_ROOT/$1"
		return
	fi
	if ! grep -q "$2" "$PKG_ROOT/$1"; then
		if [ "$3" != "" ]; then
			sed "/$3/ a$2" -i "$PKG_ROOT/$1"
		else
			echo "$2" >> "$PKG_ROOT/$1"
		fi
	fi
}

# Add our PATH to /root/.profile.
line_add "/root/.profile" ". /opt/com.brightgate/etc/com-brightgate-profile"

# Add /etc/rsyslog.d to /etc/rsyslog.conf and restart rsyslog.
line_add "/etc/rsyslog.conf" "\$IncludeConfig /etc/rsyslog.d/" "ActionFileDefaultTemplate"

optime=$(date -Iseconds)

copy_preserve () {
	if [ -f "$PKG_ROOT/$1" ]; then
		mkdir -p "$PKG_ROOT/$2"
		cp "$PKG_ROOT/$1" "$PKG_ROOT/$2"
		mv "$PKG_ROOT/$1" "$PKG_ROOT/$1.$optime"
	fi
}

copy_preserve /opt/com.brightgate/etc/secret/cloud/cloud.secret.json \
	/data/secret/rpcd

copy_preserve /opt/com.brightgate/etc/ap_props.json /data/configd
copy_preserve /opt/com.brightgate/etc/ap_props.json.bak /data/configd

copy_preserve /opt/etc/machine-id /data/mcp

copy_preserve /opt/com.brightgate/etc/secret/cloud/cloud.secret.json /data/rpcd

if [ "$PKG_ROOT" = "/" ]; then
	/etc/rc.common /etc/init.d/rsyslog restart

	# Activate Brightgate services.
	/etc/rc.common /etc/init.d/ap.mcp enable
	/etc/rc.common /etc/init.d/brightgate-appliance enable

	/etc/rc.common /etc/init.d/ap.mcp start
	/etc/rc.common /etc/init.d/brightgate-appliance start
fi
