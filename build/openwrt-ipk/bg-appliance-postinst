#!/bin/ash -e
#
# COPYRIGHT 2019 Brightgate Inc.  All rights reserved.
#
# This copyright notice is Copyright Management Information under 17 USC 1202
# and is included to protect this work and deter copyright infringement.
# Removal or alteration of this Copyright Management Information without the
# express written permission of Brightgate Inc is prohibited, and any
# such unauthorized removal or alteration will be a violation of federal law.
#

# Brightgate packaging policy: set -x required.
set -x

# PKG_UPGRADE=0 indicates an install or remove.

line_add () {
	# $1 - file
	# $2 - line
	if [ ! -f "$1" ]; then
		echo "$2" > "$1"
		return
	fi
	if grep -vq "$2" "$1"; then
		echo "$2" >> "$1"
	fi
}

# Add our PATH to /root/.profile.
line_add "$PKG_ROOT/root/.profile" ". /opt/com.brightgate/etc/com-brightgate-profile"

# Add /etc/rsyslog.d to /etc/rsyslog.conf and restart rsyslog.
line_add "$PKG_ROOT/etc/rsyslog.conf" "\$IncludeConfig /etc/rsyslog.d/"

if [ "$PKG_ROOT" = "/" ]; then
	/etc/rc.common /etc/init.d/rsyslog restart

	# Activate Brightgate services.
	/etc/rc.common /etc/init.d/ap.mcp enable
	/etc/rc.common /etc/init.d/brightgate-appliance enable

	/etc/rc.common /etc/init.d/ap.mcp start
	/etc/rc.common /etc/init.d/brightgate-appliance start
fi
