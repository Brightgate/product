#!/bin/sh /etc/rc.common
#
# COPYRIGHT 2019 Brightgate Inc.  All rights reserved.
#
# This copyright notice is Copyright Management Information under 17 USC 1202
# and is included to protect this work and deter copyright infringement.
# Removal or alteration of this Copyright Management Information without the
# express written permission of Brightgate Inc is prohibited, and any
# such unauthorized removal or alteration will be a violation of federal law.
#

START=60
STOP=70

USE_PROCD=1
PROG=/opt/com.brightgate/bin/ap.mcp

IDDIR=/data/mcp
IDFILE=${IDDIR}/machine-id

set_hostname () {
	echo "$1" > /proc/sys/kernel/hostname
}

# Workaround for CVE-2019-11477 and CV-2019-11478.
cve_2019_tcp_sack () {
	echo 0 > /proc/sys/net/ipv4/tcp_sack
}

start_service()
{
	# Mount /data, if not already mounted.
	/bin/df -T /data | /usr/bin/tail -1 | /bin/grep -q f2fs
	if [ $? != 0 ]; then
		/usr/bin/mount /data
		/usr/bin/pkill -HUP rsyslogd
	fi

	# Machine ID handling.
	if [ ! -d ${IDDIR} ]; then
		/bin/mkdir -p ${IDDIR}
	fi

	if [ ! -f ${IDFILE} ]; then
		MACHINE_ID=$(/usr/bin/uuidgen)
		OPTS="-nodeid $MACHINE_ID"
		set_hostname "$MACHINE_ID"
	else
		set_hostname "`cat < $IDFILE`"
	fi

	cve_2019_tcp_sack

	# Start service via procd.
	procd_open_instance
	procd_set_param stdout 1
	procd_set_param stderr 1
	procd_set_param command "${PROG}" ${OPTS}
	procd_set_param respawn
	procd_close_instance

	# Wait for chrony to synchronize the clock before everything gets to
	# start.  We try thirty times at one second intervals, waiting for the
	# clock to be synchronized to within a tenth of a second, ignoring any
	# skew.
	[ -e /var/run/chrony/chronyd.sock ] || sleep 1
	chronyc waitsync 30 .1 0 1
}
